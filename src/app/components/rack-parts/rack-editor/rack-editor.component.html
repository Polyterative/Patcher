<ng-container *ngIf="{
  rowedRackedModules:((dataService.rowedRackedModules$|async)),
  isCurrentRackPropertyOfCurrentUser:(dataService.isCurrentRackPropertyOfCurrentUser$|async),
  isCurrentRackEditable:(dataService.isCurrentRackEditable$|async)
  } as bag"
>
  <div class="col gap1"
  >
    <lib-auto-content-loading-indicator *ngIf="bag.rowedRackedModules==null;else yesdata"
                                        [skipFirstData]="true"
                                        [loadingLines]="5"
    >
    </lib-auto-content-loading-indicator>
  </div>
  
  <ng-template #yesdata>
    <lib-hero-content-card [description]="(bag.rowedRackedModules|totalModulesOfRack)+' module(s) in rack'+' /' +
                            ' '+data.hp+' HP per row'+' / ' +
                             ''+(bag.rowedRackedModules|totalHpOfRack)+' HP used' +
                             (bag.isCurrentRackPropertyOfCurrentUser?(((bag.isCurrentRackPropertyOfCurrentUser&&bag.isCurrentRackEditable)?' / Changes saved automatically':' / Unlock to make changes')):'')"
                           class="transition-all-long"
                           [ngClass]="{'editiableBG':bag.isCurrentRackPropertyOfCurrentUser&&bag.isCurrentRackEditable, 'readOnlyBG':(bag.isCurrentRackPropertyOfCurrentUser&&(!bag.isCurrentRackEditable))}"
    >
      <div class="col gap1 transition-all"
           style="overflow-x: auto;"
           [ngClass]="{'rackLocked':!(bag.isCurrentRackPropertyOfCurrentUser&&bag.isCurrentRackEditable)}"
      >
        <lib-screen-wrapper [maxSize]="data.hp+'rem'">
          <div class="col gap1 transition-all innerEditor"
               cdkDropListGroup
          >
            <mat-card-subtitle [ngStyle]="{width: data.hp+'rem'}"
                               fxLayoutAlign="center center"
                               class="widthRuler"
            >{{data.hp}}</mat-card-subtitle>
            
            <div class="col gap0">
              <ng-container *ngFor="let row of bag.rowedRackedModules; index as rowId"
              >
                <div class="row"
                     cdkDropList
                     cdkDropListOrientation="horizontal"
                     (cdkDropListDropped)="dataService.rackOrderChange$.next({event:$event, newRow:rowId,module:$event.item.data})"
                >
                  
                  <ng-container *ngFor="let rackedModule of row">
                    <div>
                      <app-module-realistic [data]="rackedModule|mapToModule"
                                            cdkDrag
                                            [cdkDragData]="rackedModule"
                                            [cdkDragDisabled]="!(bag.isCurrentRackEditable&&bag.isCurrentRackPropertyOfCurrentUser)"
                                            (contextmenu)="moduleRightClick$.next({$event:$event, rackedModule:rackedModule})"
                      >
                      </app-module-realistic>
                    </div>

                  </ng-container>
                  <!--                  <div [fxFlex]="(data.hp - (row|rackedToModules|totalHpOfModules))+'rem'"-->
                  <!--                       cdkDrag-->
                  <!--                       cdkDragDisabled="true"-->
                  <!--                       class="transition-all"-->
                  <!--                       [ngClass]="{'transparentize-half':!(bag.isCurrentRackPropertyOfCurrentUser&&bag.isCurrentRackEditable)}"-->
                  <!--                  -->
                  <!--                  >-->
                  <!--                    <app-rack-details-remaining-indicator [data]="data"-->
                  <!--                                                          [rowModules]="row|rackedToModules"-->
                  <!--                                                          fxFlex="fill"-->
                  <!--                    ></app-rack-details-remaining-indicator>-->
                  <!--                  </div>-->
                
                </div>
              </ng-container>
            </div>
            <div fxFlex="auto"></div>
          </div>
        </lib-screen-wrapper>
      </div>
    </lib-hero-content-card>
    <app-general-context-menu></app-general-context-menu>
  </ng-template>
  <ng-template #noData>
    <div fxFlex="auto">
      <div class="col gap1 animate-fadein-slowest"
      >
        <mat-card-subtitle fxLayoutAlign="center start"
                           style="padding: 1rem"
        >No modules in rack yet
        </mat-card-subtitle>
      </div>
    </div>
  </ng-template>

</ng-container>
