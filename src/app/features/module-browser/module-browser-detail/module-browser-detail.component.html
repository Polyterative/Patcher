<ng-container *ngIf="{
data:(dataService.singleModuleData$|async),
racksWithThisModule:(dataService.racksWithThisModule$|async),
patchesWithThisModule:(dataService.patchesWithThisModule$|async),
modulesBySameManufacturer:(dataService.modulesBySameManufacturer$|async),
user:(userManagementService.loggedUser$|async)
} as bag"
>
  <div class="col gap1"
  >
    <lib-hero-content-card class="modulesBG"
                           titleBig="Module details"
    >
      <div fxLayout.gt-md="row" fxLayout="column" fxLayoutGap="2rem"
      >
        <lib-screen-wrapper maxSize="36rem"
        >
          <div class="col gap2">
            <lib-clean-card>
              
              <lib-auto-content-loading-indicator *ngIf="bag.data==null;else data"
                                                  [loadingLines]="5"
                                                  [skipFirstData]="true"
              >
              </lib-auto-content-loading-indicator>
              
              
              <ng-template #data>
                <app-module-composite [data]="(bag.data)"
                                      [viewConfig]="viewConfig"
                                      style="margin: 10rem"
                ></app-module-composite>
              </ng-template>
            
            </lib-clean-card>
            <div class="col"
            >
              <div class="col gap1"
                   *ngIf="bag.data"
              >
                <div class="row gap1">
                  <!--              each 50%w -->
                  <button mat-flat-button
                          style="width: 50%"
                          (click)="submitSimilar(bag.data)"
                          [disabled]="!bag.user"
                          [matTooltip]="bag.user?'':'Please log in to submit a module'"
                  >
                    <mat-icon>upload</mat-icon>
                    Submit similar module
                  </button>
                  <ng-container *ngIf="!bag.data.isComplete">
                    <button mat-flat-button color="primary"
                            style="width: 50%"
                            [disabled]="!bag.user"
                            *ngIf="bag.data
                            &&(dataService.moduleEditingPanelOpenState$|async)===false"
                            (click)="dataService.moduleEditingPanelOpenState$.next(!dataService.moduleEditingPanelOpenState$.value)"
                    >
                      <mat-icon>edit</mat-icon>
                      Open editor
                    </button>
                    <button mat-flat-button color="primary"
                            style="width: 50%"
                            [disabled]="!bag.user"
                            *ngIf="bag.data
                            &&(dataService.moduleEditingPanelOpenState$|async)===true"
                            (click)="dataService.moduleEditingPanelOpenState$.next(!dataService.moduleEditingPanelOpenState$.value)"
                    >
                      <mat-icon>close</mat-icon>
                      Close editor
                    </button>
                  </ng-container>
                  
                  <button mat-flat-button
                          *ngIf="bag.data&&bag.data.isComplete&&bag.data.manualURL"
                          style="width: 50%"
                          (click)="openManual(bag.data)"
                  >
                    <mat-icon>menu_book</mat-icon>
                    Open manual
                  </button>
                </div>
              
              
              </div>
              <p fxLayoutAlign="end"
                 style="font-size: 1rem; font-family: 'Roboto', sans-serif"
                 *ngIf="bag.data&&!bag.data.isComplete&&!viewConfig.hideLabels&&(bag.data.manufacturer.id!==10000)"
              >
                Do you know about this module?
                Please help the community by adding the module's ins and outs.
                Contributors' patches DO sound better!
              </p>
            </div>
            
            <lib-hero-content-card titleNormal="Search on" *ngIf="bag.data">
              <div class="rowwrap gap1">
                <ng-container *ngFor="let link of searchLinks">
                  <a [href]="link.url(bag.data.name, bag.data.manufacturer.name)"
                     rel="noopener noreferrer" target="_blank" [attr.aria-label]="'Search on ' + link.label">
                    <button mat-flat-button>
                      <mat-icon *ngIf="link.icon">{{ link.icon }}</mat-icon>
                      <span>{{ link.label }}</span>
                    </button>
                  </a>
                </ng-container>
              </div>
            </lib-hero-content-card>
            
            <lib-hero-content-card titleNormal="Dev utils" *ngIf="appState.isDev&&bag.data&&bag.user">
              <div class="rowwrap gap2">
                <button mat-flat-button color="warn"
                        *ngIf="bag.data.isComplete===false"
                        (click)="dataService.deleteModule$.next(bag.data.id)">Delete module
                </button>
                <button mat-flat-button color="warn"
                        *ngIf="bag.data.isComplete===false"
                        (click)="dataService.deleteLastPanel$.next(bag.data)">Delete last panel
                </button>
                <button mat-flat-button color="primary"
                        *ngIf="bag.data&&bag.data.standard.id!==1"
                        (click)="dataService.changeModule$.next({
                standard:{
                id:1,
                name:''
                }
                })">
                  Convert to 1U Intellijel
                </button>
                
                <button mat-flat-button color="primary"
                        *ngIf="bag.data&&bag.data.standard.id!==0"
                        (click)="dataService.changeModule$.next({
                standard:{
                id:0,
                name:''
                }
                })">Convert to 3U Doepfer
                </button>
                
                <button mat-flat-button color="primary"
                        *ngIf="bag.data&&bag.data.isComplete===false"
                        (click)="dataService.changeModule$.next({
                isComplete:true
                })">Mark as complete
                </button>
                
                <button mat-flat-button color="primary"
                        *ngIf="bag.data&&bag.data.isComplete===true"
                        (click)="dataService.changeModule$.next({
                isComplete:false
                })">Mark as incomplete
                </button>
                <button mat-flat-button color="primary"
                        *ngIf="bag.data&&bag.data.isApproved===false"
                        (click)="dataService.changeModule$.next({
                isApproved:true
                })">Mark as approved
                </button>
                
                <button mat-flat-button color="primary"
                        *ngIf="bag.data&&bag.data.isApproved===true"
                        (click)="dataService.changeModule$.next({
                isComplete:false
                })">Mark as unapproved
                </button>
                
                <!--                <pre>-->
                <!--                  {{ bag.data|json }}-->
                <!--                </pre>-->
              
              
              </div>
            </lib-hero-content-card>
          </div>
          
          <app-comments-root></app-comments-root>
        
        
        </lib-screen-wrapper>
        
        <div fxFlex class="col gap2"
          >
            <lib-hero-content-card *ngIf="bag.data&&dataService.moduleEditingPanelOpenState$|async"
                                   titleNormal="Module Editor"
            >
              <app-module-editor [data]="(bag.data)"
              ></app-module-editor>
            </lib-hero-content-card>
            
            <div fxLayout.gt-md="row"
                 fxLayout="column"
                 fxLayoutGap="1rem"
            >
              <lib-hero-content-card *ngIf="viewConfig.hideRackedIn===false"
                                     style="flex: 1 1 100%;"
                                     titleNormal="Racked in"
              >
                <lib-auto-content-loading-indicator [data$]="dataService.racksWithThisModule$"
                                                    [updateData$]="dataService.updateSingleModuleData$"
                >
                  <app-module-racks
                    *ngIf="(bag.racksWithThisModule)&&(bag.racksWithThisModule).length>0; else noRacks"
                    [data$]="dataService.racksWithThisModule$"
                  ></app-module-racks>
                </lib-auto-content-loading-indicator>
              </lib-hero-content-card>
              <lib-hero-content-card *ngIf="viewConfig.hidePatchedIn===false"
                                     style="flex: 1 1 100%;"
                                     titleNormal="Patched in"
              >
                
                
                <lib-auto-content-loading-indicator [data$]="dataService.patchesWithThisModule$"
                                                    [updateData$]="dataService.updateSingleModuleData$"
                >
                  <app-module-patches
                    *ngIf="(bag.patchesWithThisModule)&&(bag.patchesWithThisModule).length>0; else noPatches"
                    [data$]="dataService.patchesWithThisModule$"
                  ></app-module-patches>
                </lib-auto-content-loading-indicator>
              </lib-hero-content-card>
            </div>
            
            <lib-hero-content-card *ngIf="bag.data?.manufacturer&&viewConfig.hideBySameManufacturer===false"
                                   [titleNormal]="'Others by *'+(bag.data.manufacturer.name) + '*'"
                                   fxFlex
            >
              
              
              <lib-auto-content-loading-indicator [data$]="dataService.modulesBySameManufacturer$"
                                                  [updateData$]="dataService.updateSingleModuleData$"
              >
                <app-module-list
                  *ngIf="(bag.modulesBySameManufacturer)&&(bag.modulesBySameManufacturer).length>0; else noModulesWithSameManufacturer"
                  [data$]="dataService.modulesBySameManufacturer$"
                  [viewConfig]="bySameManufacturerViewConfig"
                ></app-module-list>
              </lib-auto-content-loading-indicator>
            </lib-hero-content-card>
          </div>
      
      </div>
    </lib-hero-content-card>
  </div>
</ng-container>

<ng-template #noRacks>
  <div class="col gap1 animate-fadein-slowest"
  >
    <mat-card-subtitle fxLayoutAlign="center start"
                       style="padding: 1rem"
    >No racks using this module yet. Try adding it to yours!
    </mat-card-subtitle>
  </div>
</ng-template>
<ng-template #noPatches>
  <div class="col gap1 animate-fadein-slowest"
  >
    <mat-card-subtitle fxLayoutAlign="center start"
                       style="padding: 1rem"
    >No patches using this module yet. Try adding it to yours!
    </mat-card-subtitle>
  </div>
</ng-template>

<ng-template #noModulesWithSameManufacturer>
  <div class="col gap1 animate-fadein-slowest"
  >
    <mat-card-subtitle fxLayoutAlign="center start"
                       style="padding: 1rem"
    >No more modules by this manufacturer yet.
    </mat-card-subtitle>
  </div>
</ng-template>